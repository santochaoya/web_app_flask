# Create Users

## Hash password

Here, we use **Bcrypt** to hash our password. After we registering the account, the application will hash the password and save it to the database.



### Install

```python
pip install flask-bcrypt
```



### Hash password

#### Generate hashed password

```python
from flask_bcrypt import Bcrypt

bcrypt = Bcrypt()
bcrypt.generate_password_hash('testing')
```

It will generate a bites hashed code.

```bash
b'$2b$12$g0YpQMfeF3Y8pIumUHQSfOjqpjBMFgTKmrgU0xCevRBhotnUj0nNO'
```

or getting a string from ```utf-8```

```python
bcrypt.generate_password_hash('testing').decode('utf-8')
```

```bash
'$2b$12$sBJ/cDKNox7puebep9nvNu1obucpVYvUuxfUXQHFvD3v1Dj272BLO'
```



#### Check hashed password

```python
hash_pw = bcrypt.generate_password_hash('testing').decode('utf-8')
bcrypt.check_password_hash(hash_pw, 'testing')
```

```bash
>> True
```

```python
bcrypt.check_password_hash(hash_pw, 'password')
```

```
>> False
```



## Create users

* ```__init__.py```

  ```python
  from flask_bcrypt import Bcrypt
  
  bcrypt = Bcrypt(app)
  ```



* ```routes.py```

  ```python
  from flaskbloc import app, db, bcrypt
  
  # <-- inside the register function -->
  if form.validation_on_submit():
    	hashed_password = bcrypt.generate_password_hash(form.password.data).decode('utf-8')
      user = User(username=form.username.data, email=form.email.data, password=hashed_password)
      # Add user to database
      db.session.add(user)
      db.session.commit()
  ```

   

## Add only valid users to database

### Existing username

We add some error message in the front-end to indicate that issue in a function.

```python
from flaskblog.models import User
from wtforms.validators import ValidationError
# <-- in the form.py/RegistrationForm(FlaskForm) -->

def validate_username(self, username):
  	user = User.query.filter_by(username=username.data).first()
		if user:
      	raise ValidationError('Username exists, please choose another one.')
```



###  Unique email

```python
def validate_email(self, email):
		email = User.query.filter_by(email=email.data).first()
		if email:
				raise ValidationError('Email exists, please chosse another one.')
```



# Login & Logout

## LoginManager

When we access to the database, the ```LoginManager``` will help us handle session and backends.

### Import

in ```__init__.py```

```python
from flask_login import LoginManager

login_manager = LoginManager(app)
```



### Reload users in session

Create a function ```user_loader``` to read the **User ID** stored in the session. In ```models.py```:

```python
def load_user(user_id):
  	"""Get the user by user id."""
		return User.query.get(int(user_id))
```



### Bind function to user_loader extention

Specify a decorator to bind the login manager to the ```load_user```function.

```python
@login_manager.user_loder
```



### Attributes and method for user models:

* **Authenticated**: This is required from the extension, which will return ```True``` if a valid credentials are provided.

* **Is active**

* **Anonymous**

* **Get ID**

We inherit all these attributes from a specific class ```UserMixin```. Inherit it by passing it to the class in ```models.py``` which set up our database.

```python
class User(db.Model, UserMixin):
```



### Check username and password

Compare the type-in message to the username and email in the database. If it is correctly, the app will log the user in. Then go back to the home page.

```python
user = User.query.filter_bu(username=form.username.data).first()
if user and bcrypt.check_password_hash(user.password, form.password.data):
  	login_user(user, remember=form.remember.data)
    return redirect(url_for('home'))
else:
  	flask('Unsuccessful.......')
```

* ```if user``` to check if the username exist.
* ```bcrypt.check_password_hash(<password in db>, <password typed-in>)``` to check if the password correct.
* ```login_user(user, remember=form.remember.data)``` to let user login. The argument ```remember``` will get ```True``` or ```False``` from the parameter ```form.remember.data``  to complish if the application remember the login status.